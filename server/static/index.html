<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vision Server Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #0b1220;
      color: #e6edf3;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
    }

    .top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
    }

    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #111b32;
      border: 1px solid #1c2a4f;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 14px;
    }

    .card {
      background: #0f1a33;
      border: 1px solid #1c2a4f;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
    }

    .video {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #1c2a4f;
      background: #081024;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat {
      background: #0b1430;
      border: 1px solid #1c2a4f;
      border-radius: 12px;
      padding: 10px;
    }

    .stat .k {
      font-size: 12px;
      opacity: .8;
    }

    .stat .v {
      font-size: 18px;
      font-weight: 700;
      margin-top: 4px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    button {
      cursor: pointer;
      border: 1px solid #27406f;
      background: #13224a;
      color: #e6edf3;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
    }

    button:hover {
      background: #162a5b;
    }

    label {
      font-size: 12px;
      opacity: .85;
    }

    input[type="range"] {
      width: 100%;
    }

    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.4;
      height: 210px;
      overflow: auto;
      background: #07102a;
      border: 1px solid #1c2a4f;
      border-radius: 12px;
      padding: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Vision Server Dashboard</div>
      <div class="pill" id="conn">Connecting…</div>
    </div>

    <div class="grid">
      <div class="card">
        <img class="video" id="stream" src="/preview.jpg?ts=0" alt="Latest annotated ROI" />
      </div>

      <div class="card">
        <div class="stats">
          <div class="stat">
            <div class="k">Latency (ms)</div>
            <div class="v" id="lat">—</div>
          </div>

          <div class="stat">
            <div class="k">Detections</div>
            <div class="v" id="count">—</div>
          </div>

          <div class="stat">
            <div class="k">Best guess</div>
            <div class="v" id="det">—</div>
          </div>

          <div class="stat">
            <div class="k">Confidence</div>
            <div class="v" id="conf">—</div>
          </div>

          <div class="stat">
            <div class="k">Last update</div>
            <div class="v" id="ts">—</div>
          </div>

          <div class="stat" style="grid-column: 1 / -1;">
            <div class="k">Top 3 guesses</div>
            <div class="v" id="top3" style="font-size:14px; font-weight:600; line-height:1.5;">—</div>
          </div>
        </div>

        <hr style="border:0;border-top:1px solid #1c2a4f; margin: 12px 0;" />

        <div class="controls">
          <!-- NOTE: Your server currently supports threshold + overlay.
               If you haven't implemented running start/stop, these buttons will be no-ops (safe). -->
          <button onclick="postConfig({running:true})">Start inference</button>
          <button onclick="postConfig({running:false})">Stop inference</button>

          <div>
            <label>Confidence threshold: <span id="thrLabel">0.25</span></label>
            <input type="range" min="0" max="1" step="0.01" value="0.25" id="thr" />
          </div>

          <button id="overlayBtn" onclick="toggleOverlay()">Overlay: ON</button>
        </div>

        <hr style="border:0;border-top:1px solid #1c2a4f; margin: 12px 0;" />
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById("log");
    const connEl = document.getElementById("conn");
    const thr = document.getElementById("thr");
    const thrLabel = document.getElementById("thrLabel");
    const overlayBtn = document.getElementById("overlayBtn");

    let overlayOn = true;
    let lastVersion = -1;

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    function renderTop3(topk) {
      if (!Array.isArray(topk) || topk.length === 0) return "—";
      return topk
        .slice(0, 3)
        .map((g, i) => `${i + 1}. ${g.label} (${Number(g.conf).toFixed(2)})`)
        .join("\n");
    }

    function setConnected(yes) {
      if (yes) {
        connEl.textContent = "Connected";
        connEl.style.background = "#0e2a1a";
        connEl.style.borderColor = "#1f6f3a";
      } else {
        connEl.textContent = "Disconnected";
        connEl.style.background = "#2a1111";
        connEl.style.borderColor = "#6f1f1f";
      }
    }

    async function postConfig(payload) {
      try {
        const r = await fetch("/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!r.ok) throw new Error("config failed");
        const data = await r.json();
        log("Config updated: " + JSON.stringify(data));
      } catch (e) {
        log("Config error: " + e.message);
      }
    }

    function toggleOverlay() {
      overlayOn = !overlayOn;
      overlayBtn.textContent = "Overlay: " + (overlayOn ? "ON" : "OFF");
      postConfig({ overlay: overlayOn });
    }

    async function poll() {
      try {
        const r = await fetch("/status", { cache: "no-store" });
        if (!r.ok) throw new Error("status not ok");
        const s = await r.json();

        setConnected(true);

        // Core stats
        document.getElementById("lat").textContent = s.latency_ms ?? "—";
        document.getElementById("count").textContent = s.detections_count ?? "—";
        document.getElementById("top3").textContent = renderTop3(s.topk);

        // Best guess = topk[0]
        const best = Array.isArray(s.topk) && s.topk.length ? s.topk[0] : null;
        document.getElementById("det").textContent = best?.label ?? "—";
        document.getElementById("conf").textContent = (best?.conf != null) ? Number(best.conf).toFixed(2) : "—";

        // Last update time (server ts is seconds since epoch)
        document.getElementById("ts").textContent =
          s.ts ? new Date(s.ts * 1000).toLocaleTimeString() : "—";

        // Sync slider + overlay button from server (if provided)
        if (typeof s.conf_threshold === "number") {
          thr.value = s.conf_threshold;
          thrLabel.textContent = Number(s.conf_threshold).toFixed(2);
        }
        if (typeof s.overlay === "boolean") {
          overlayOn = s.overlay;
          overlayBtn.textContent = "Overlay: " + (overlayOn ? "ON" : "OFF");
        }

        // Refresh preview only when a new frame arrived
        if (typeof s.preview_version === "number" && s.preview_version !== lastVersion) {
          lastVersion = s.preview_version;
          document.getElementById("stream").src = "/preview.jpg?ts=" + Date.now();
        }
      } catch (e) {
        setConnected(false);
      }
    }

    thr.addEventListener("input", () => {
      thrLabel.textContent = Number(thr.value).toFixed(2);
    });
    thr.addEventListener("change", () => {
      postConfig({ threshold: Number(thr.value) });
    });

    log("Dashboard loaded");
    setInterval(poll, 500);
    poll();
  </script>
</body>

</html>
